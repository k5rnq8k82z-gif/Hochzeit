<!doctype html>
<html lang="de">
<head>
  <title>Admin – Hochzeit</title>
  
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0a0f15; --panel:rgba(255,255,255,.06); --panel2:rgba(255,255,255,.08);
      --fg:#eef2fa; --muted:#9fb0c7; --brand:#ff8fb2; --brand2:#78d3ff; --accent:#ffd166;
      --ok:#39d353; --error:#ff6b6b; --border:rgba(255,255,255,.12); --radius:16px;
      --shadow:0 12px 34px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:
      radial-gradient(1400px 700px at 8% -10%, rgba(255,143,178,.10), transparent 60%),
      radial-gradient(1200px 600px at 105% 10%, rgba(120,211,255,.10), transparent 60%),
      linear-gradient(180deg,#0b1016 0%,#0c1118 50%,#0a0f15 100%);
      color:var(--fg); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      min-height:100vh;
    }
    a{color:var(--brand2);text-decoration:none}
    img{max-width:100%;display:block;border-radius:14px}
    header{position:sticky;top:0;z-index:30;background:rgba(10,15,21,.6);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    nav{display:flex;align-items:center;justify-content:space-between;gap:16px}
    .brand{display:flex;align-items:center;gap:12px;font-weight:800;letter-spacing:.3px}
    .brand .dot{width:12px;height:12px;border-radius:50%;background:conic-gradient(from 45deg,var(--brand),var(--brand2),var(--accent));box-shadow:0 0 22px rgba(255,143,178,.8)}
    .navlinks a{padding:8px 12px;border-radius:10px}
    .navlinks a:hover{background:var(--panel2)}
    .hero{padding:72px 20px 24px;text-align:center}
    .hero h1{font-size:clamp(28px,5.5vw,56px);margin:0 0 8px}
    .hero p{margin:0;color:var(--muted)}
    section{padding:28px 20px 12px}
    .grid{display:grid;gap:18px;grid-template-columns:repeat(12,1fr)}
    .col-12{grid-column:span 12}
    .col-6{grid-column:span 12}
    @media(min-width:900px){.col-6{grid-column:span 6}}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:999px;background:var(--panel2);border:1px solid var(--border)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;border:0;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:800;color:#0a0f15;background:linear-gradient(135deg,var(--brand),var(--brand2));box-shadow:0 10px 20px rgba(255,137,168,.25),0 6px 18px rgba(138,198,255,.18)}
    .btn.ghost{background:transparent;color:var(--fg);border:1px solid var(--border)}
    .hint{color:var(--muted);font-size:14px}
    form label{display:block;font-weight:700;margin:12px 0 6px}
    input[type=text],input[type=email],input[type=number],textarea,select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.07);color:var(--fg);outline:none}
    textarea{min-height:90px;resize:vertical}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>*{flex:1;min-width:160px}
    .radios{display:flex;gap:12px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:999px;border:1px solid var(--border);cursor:pointer;background:rgba(255,255,255,.07)}
    .chip[data-checked=true]{outline:2px solid rgba(255,255,255,.2);background:rgba(255,255,255,.12)}

    /* Splash */
    #splash{position:fixed;inset:0;z-index:1000;background:#000 url('img/hero.jpg') center/cover no-repeat;display:grid;place-items:center;transition:opacity .9s ease}
    #splash::after{content:"";position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.2),rgba(0,0,0,.55))}
    #splash .title{position:relative;z-index:2;text-align:center;padding:16px 24px;border-radius:999px;background:rgba(255,255,255,.14);backdrop-filter:blur(8px);box-shadow:var(--shadow);font-weight:800;letter-spacing:.6px}
    #splash.hide{opacity:0;pointer-events:none}

    /* Gallery */
    .gallery{display:grid;gap:12px;grid-template-columns:repeat(2,1fr)}
    @media(min-width:760px){.gallery{grid-template-columns:repeat(4,1fr)}}
    .gallery .tile{position:relative;overflow:hidden;border-radius:14px;border:1px solid var(--border);background:#111}
    .gallery .tile img{width:100%;height:100%;object-fit:cover;aspect-ratio:1/1}
    .tile .dl{position:absolute;right:8px;bottom:8px;background:rgba(0,0,0,.5);border:1px solid var(--border);padding:6px 10px;border-radius:10px;color:#fff;text-decoration:none}

    .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:80}
    .lightbox.show{display:flex}
    .lightbox img{max-width:92vw;max-height:82vh;border-radius:14px}
    .lightbox .close{position:absolute;top:14px;right:18px;font-size:28px;cursor:pointer;color:#fff}

    footer{padding:60px 20px;text-align:center;color:var(--muted)}
  </style>

</head>
<body>
  <header>
    <div class="wrap">
      <nav>
        <div class="brand"><span class="dot"></span> <span>Admin</span></div>
        <div class="navlinks">
          <a href="index.html">Zur Website</a>
        </div>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <h2>Admin-Zugriff</h2>
      <div class="row">
        <input id="admToken" type="text" placeholder="Admin-Token (wie im Script gesetzt)">
        <button class="btn" id="saveToken">Merken</button>
      </div>
      <p class="hint" id="tokenHint" style="margin-top:6px;">Token wird lokal gespeichert.</p>
    </section>

    <section class="card" style="margin-top:18px;">
      <h2>RSVP-Übersicht</h2>
      <div class="row">
        <button class="btn" id="admLoad">Laden</button>
        <button class="btn ghost" id="admCsv">CSV exportieren</button>
      </div>
      <p class="hint" id="admHint" style="margin-top:8px;"></p>
      <div style="overflow:auto; margin-top:12px;">
        <table id="admTable" aria-label="RSVP-Tabelle" style="width:100%; border-collapse:collapse;">
          <thead><tr>
            <th style="text-align:left;padding:8px;">Zeit</th>
            <th style="text-align:left;padding:8px;">Name</th>
            <th style="text-align:left;padding:8px;">Zusage</th>
            <th style="text-align:left;padding:8px;">Begl. Anzahl</th>
            <th style="text-align:left;padding:8px;">Begl. Details</th>
            <th style="text-align:left;padding:8px;">E-Mail</th>
            <th style="text-align:left;padding:8px;">Nachricht</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card" style="margin-top:18px;">
      <h2>Galerie verwalten</h2>
      <p class="hint">Bilder auswählen und hochladen – erscheinen öffentlich in der Galerie. (Apps Script muss <code>type=gallery</code> unterstützen.)</p>
      <div class="row">
        <input type="file" id="galFiles" accept="image/*" multiple>
        <button class="btn" id="galUpload">Hochladen</button>
        <button class="btn ghost" id="galRefresh">Liste aktualisieren</button>
      </div>
      <p id="galStatus" class="hint" style="margin-top:8px;"></p>
      <div id="galList" style="display:grid;gap:10px;margin-top:10px;"></div>
    </section>

    <section class="card" style="margin-top:18px;">
      <h2>Chat ansehen</h2>
      <div class="row">
        <button class="btn" id="admLoadChat">Laden</button>
      </div>
      <p class="hint" id="admChatHint" style="margin-top:8px;"></p>
      <div id="admChatList" style="margin-top:10px; display:grid; gap:10px;"></div>
    </section>

    <section class="card" style="margin-top:18px;">
      <h2>Backend (Apps Script) – Galerie-Erweiterung</h2>
      <p class="hint">Füge diese Teile in dein <strong>Code.gs</strong> ein, zusätzlich zu RSVP & Chat:</p>
      <pre style="white-space:pre-wrap;font-size:13px;background:rgba(0,0,0,.4);padding:12px;border-radius:12px;border:1px solid var(--border)">
// In Script Properties setze: TOKEN=<dein token>, FOLDER_ID=<optional Google Drive Ordner-ID>
function galleryUpload_(p) {
  var need = PropertiesService.getScriptProperties().getProperty('TOKEN') || '';
  if (!need || (p.token||'') !== need) return { ok:false, error:'Unauthorized' };
  var folderId = PropertiesService.getScriptProperties().getProperty('FOLDER_ID');
  var folder = folderId ? DriveApp.getFolderById(folderId) : DriveApp.getRootFolder();
  var contentType = p.contentType || 'image/jpeg';
  var bytes = Utilities.base64Decode(p.base64 || '');
  var blob = Utilities.newBlob(bytes, contentType, p.filename || ('bild_'+Date.now()+'.jpg'));
  var file = folder.createFile(blob);
  try { file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW); } catch(e) {} // optional
  var id = file.getId();
  var url = 'https://drive.google.com/uc?export=view&id=' + id;       // für IMG
  var download = 'https://drive.google.com/uc?export=download&id=' + id; // für Download
  var sh = SpreadsheetApp.getActive().getSheetByName('Gallery') || SpreadsheetApp.getActive().insertSheet('Gallery');
  if (sh.getLastRow() === 0) sh.getRange(1,1,1,5).setValues([['timestamp','filename','url','download','uploader']]);
  var ts = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyy-MM-dd HH:mm:ss');
  sh.appendRow([ts, file.getName(), url, download, p.uploader || 'admin']);
  return { ok:true, url:url, download:download, filename:file.getName() };
}
function galleryList_() {
  var sh = SpreadsheetApp.getActive().getSheetByName('Gallery');
  if (!sh) return { ok:true, rows:[] };
  var values = sh.getDataRange().getValues(); values.shift();
  var rows = values.map(function(r){ return { timestamp:r[0], filename:r[1], url:r[2], download:r[3], uploader:r[4] }; });
  return { ok:true, rows:rows };
}
/* In doPost(e): */
// if (type==='gallery' && (p.action||'')==='upload') return json(galleryUpload_(p));
/* In doGet(e): */
// if (type==='gallery' && (p.list==='1' || p.list==='true')) return json(galleryList_());
      </pre>
    </section>
  </main>

  <script>
    const SHEET_ENDPOINT = "https://script.google.com/macros/s/AKfycbzFiGVXqdeDVQH7cENcb123mg4at0I9Xhjv-D599mkVkqUSMtSygDhgIUmP29PVS9CP/exec";
    const $ = sel => document.querySelector(sel);

    // Token storage
    const tInput = $('#admToken'); const tHint = $('#tokenHint');
    const tokenKey = 'wedding_admin_token';
    tInput.value = localStorage.getItem(tokenKey) || '';
    $('#saveToken').addEventListener('click', () => { localStorage.setItem(tokenKey, tInput.value.trim()); tHint.textContent = 'Token gespeichert.'; });

    // RSVP load
    $('#admLoad').addEventListener('click', loadRSVP);
    $('#admCsv').addEventListener('click', exportCsv);
    $('#admLoadChat').addEventListener('click', loadChat);

    async function loadRSVP(){
      const token = tInput.value.trim();
      const hint = $('#admHint');
      const tbody = document.querySelector('#admTable tbody');
      hint.textContent = "Lade..."; tbody.innerHTML = "";
      try {
        const url = new URL(SHEET_ENDPOINT);
        url.searchParams.set('token', token);
        url.searchParams.set('type', 'rsvp');
        const res = await fetch(url.toString()); const j = await res.json();
        if (!j.ok) throw new Error(j.error||'Fehler');
        const rows = j.rows || [];
        rows.forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="padding:8px;">${r.timestamp||''}</td>
            <td style="padding:8px;">${r.name||''}</td>
            <td style="padding:8px;">${r.attending||''}</td>
            <td style="padding:8px;">${r.guests||''}</td>
            <td style="padding:8px;">${[r.c1name,r.c1age,r.c2name,r.c2age,r.c3name,r.c3age,r.c4name,r.c4age].filter(Boolean).join(' • ')}</td>
            <td style="padding:8px;">${r.email||''}</td>
            <td style="padding:8px;">${r.message||''}</td>`;
          tbody.appendChild(tr);
        });
        hint.textContent = `Einträge: ${rows.length}`;
      } catch(e) { hint.textContent = "Laden fehlgeschlagen – stimmt der Token & doGet?"; }
    }

    function exportCsv(){
      const rows = Array.from(document.querySelectorAll('#admTable tbody tr')).map(tr => Array.from(tr.children).map(td => td.textContent));
      const header = ['timestamp','name','attending','guests','companions','email','message'];
      const esc = v => `"${String(v??'').replace(/"/g,'""')}"`;
      const lines = [header.join(',')].concat(rows.map(r => r.map(esc).join(',')));
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob); const a = Object.assign(document.createElement('a'), {href:url, download:'rsvps.csv'});
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    async function loadChat(){
      const token = tInput.value.trim();
      const hint = $('#admChatHint'); const list = $('#admChatList');
      hint.textContent = "Lade..."; list.innerHTML = "";
      try {
        const url = new URL(SHEET_ENDPOINT); url.searchParams.set('token', token); url.searchParams.set('type','chat');
        const res = await fetch(url.toString()); const j = await res.json();
        if (!j.ok) throw new Error(j.error||'Fehler');
        (j.rows||[]).slice(-100).reverse().forEach(r => {
          const div = document.createElement('div'); div.className = 'card';
          div.innerHTML = `<strong>${r.name||'Gast'}</strong><div class="hint" style="margin-top:4px;">${r.message||''}</div>`; list.appendChild(div);
        });
        hint.textContent = `Chat-Nachrichten: ${(j.rows||[]).length}`;
      } catch(e) { hint.textContent = "Chat laden fehlgeschlagen."; }
    }

    // Gallery Admin
    const galFiles = $('#galFiles'); const galUpload = $('#galUpload');
    const galRefresh = $('#galRefresh'); const galStatus = $('#galStatus'); const galList = $('#galList');

    galUpload.addEventListener('click', async () => {
      const token = tInput.value.trim();
      if (!token) { galStatus.textContent = "Bitte zuerst den Admin-Token speichern."; return; }
      if (!galFiles.files.length) { galStatus.textContent = "Bitte Bilder auswählen."; return; }
      galStatus.textContent = "Lade hoch …";
      let okCount = 0; let failCount = 0;
      for (const file of galFiles.files) {
        try {
          const base64 = await fileToBase64(file);
          const b64 = base64.split(',')[1] || base64; // strip data URL prefix
          const res = await fetch(SHEET_ENDPOINT, {
            method: "POST",
            headers: {"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},
            body: new URLSearchParams({
              type: "gallery", action: "upload", token,
              filename: file.name, contentType: file.type, base64: b64, uploader: "admin"
            }).toString()
          });
          const j = await res.json();
          if (j.ok) okCount++; else failCount++;
        } catch(e) { failCount++; }
      }
      galStatus.textContent = `Fertig: ${okCount} erfolgreich, ${failCount} fehlgeschlagen.`;
      listGalleryAdmin();
      galFiles.value = "";
    });

    galRefresh.addEventListener('click', listGalleryAdmin);

    async function listGalleryAdmin(){
      galList.innerHTML = "";
      try {
        const url = new URL(SHEET_ENDPOINT); url.searchParams.set('type','gallery'); url.searchParams.set('list','1');
        const res = await fetch(url); const j = await res.json();
        if (!j.ok) throw new Error();
        (j.rows||[]).forEach(it => {
          const div = document.createElement('div'); div.className = 'row card'; div.style.alignItems='center';
          div.innerHTML = `<div style="flex:0 0 80px"><img src="${it.url}" alt="" style="width:80px;height:80px;object-fit:cover;border-radius:12px"></div>
                           <div style="flex:1;min-width:180px"><strong>${it.filename||'Bild'}</strong><div class="hint">${it.timestamp||''}</div></div>
                           <div style="flex:0 0 auto;display:flex;gap:8px">
                             <a class="btn ghost" href="${it.url}" target="_blank">Ansehen</a>
                             <a class="btn" href="${it.download||it.url}" download>Download</a>
                           </div>`;
          galList.appendChild(div);
        });
      } catch(e) { galStatus.textContent = "Galerie nicht ladbar – Backend prüfen."; }
    }

    function fileToBase64(file) { return new Promise((res, rej) => { const r = new FileReader(); r.onload = () => res(r.result); r.onerror = rej; r.readAsDataURL(file); }); }
  </script>
</body>
</html>
