/* ===== CONFIG ===== */
const SHEET_RSVP   = 'rsvp';
const SHEET_CHAT   = 'chat';
const SHEET_TEXTS  = 'texts';
const SHEET_GAL    = 'gallery';
const DRIVE_FOLDER = 'wedding_gallery'; // wird automatisch erstellt

/* ===== Helpers ===== */
function json_(obj, code){ const out=ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON); if(code) out.setResponseCode(code); return out; }
function needToken_(params){
  const want = (params.token||'').trim();
  const have = (PropertiesService.getScriptProperties().getProperty('TOKEN')||'').trim();
  if (!have || want !== have) throw new Error('Unauthorized');
}
function ensureSheet_(name, header){
  const ss=SpreadsheetApp.getActive(); let sh=ss.getSheetByName(name); if(!sh) sh=ss.insertSheet(name);
  if(header && header.length){
    const rng=sh.getRange(1,1,1,header.length); const cur=rng.getValues()[0]||[];
    if(header.join('|')!==cur.join('|')) rng.setValues([header]);
  }
  return sh;
}
function getFolder_(){
  const folders = DriveApp.getFoldersByName(DRIVE_FOLDER);
  if (folders.hasNext()) return folders.next();
  return DriveApp.createFolder(DRIVE_FOLDER);
}

/* ===== Public endpoints ===== */
function doPost(e){
  try{
    const p = e.parameter || {};
    const type = (p.type||'').toLowerCase();

    // Visitors: RSVP / CHAT submit (no token)
    if(type==='rsvp'){
      const sh = ensureSheet_(SHEET_RSVP, ['timestamp','name','attending','guests','email','message','c1name','c1age','c2name','c2age','c3name','c3age','c4name','c4age','ua']);
      sh.appendRow([new Date(), p.name||'', p.attending||'', p.guests||'', p.email||'', p.message||'',
        p.c1name||'', p.c1age||'', p.c2name||'', p.c2age||'', p.c3name||'', p.c3age||'', p.c4name||'', p.c4age||'', p.ua||'']);
      return json_({ok:true});
    }
    if(type==='chat'){
      const sh = ensureSheet_(SHEET_CHAT, ['timestamp','name','message','ua']);
      sh.appendRow([new Date(), p.name||'Gast', p.message||'', p.ua||'']);
      return json_({ok:true});
    }

    // Admin actions (token)
    needToken_(p);

    if(type==='texts_set'){
      const sh = ensureSheet_(SHEET_TEXTS, ['key','value']);
      const map = {
        hero_subtitle: p.hero_subtitle||'',
        info_dresscode: p.info_dresscode||'',
        info_gifts: p.info_gifts||'',
        info_kids: p.info_kids||'',
        info_hashtag: p.info_hashtag||''
      };
      const keys = Object.keys(map);
      // simple upsert
      const data = sh.getDataRange().getValues(); // header + rows
      const idx = {}; for(let i=1;i<data.length;i++){ idx[data[i][0]]=i+1; }
      keys.forEach(k=>{
        if(idx[k]){ sh.getRange(idx[k],2).setValue(map[k]); }
        else{ sh.appendRow([k, map[k]]); }
      });
      return json_({ok:true});
    }

    if(type==='gallery_upload'){
      const folder = getFolder_();
      const filename = p.filename || ('bild_'+Date.now()+'.jpg');
      const contentType = p.mime || 'image/jpeg';
      const bytes = Utilities.base64Decode(p.data||'');
      const blob = Utilities.newBlob(bytes, contentType, filename);
      const file = folder.createFile(blob);
      file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
      const url = 'https://drive.google.com/uc?export=view&id=' + file.getId();

      const sh = ensureSheet_(SHEET_GAL, ['id','timestamp','filename','url']);
      sh.appendRow([file.getId(), new Date(), filename, url]);
      return json_({ok:true, id:file.getId(), url});
    }

    if(type==='gallery_delete'){
      const id = (p.id||'').trim();
      if(id){
        try{ DriveApp.getFileById(id).setTrashed(true); }catch(_){} // ignore if not found
        const sh = ensureSheet_(SHEET_GAL, ['id','timestamp','filename','url']);
        const rng = sh.getDataRange().getValues();
        for(let i=1;i<rng.length;i++){
          if(String(rng[i][0])===id){ sh.deleteRow(i+1); break; }
        }
      }
      return json_({ok:true});
    }

    if(type==='chat_delete'){
      const row = parseInt(p.row,10); // absolute row in sheet (1-based)
      const sh = ensureSheet_(SHEET_CHAT, ['timestamp','name','message','ua']);
      if(row && row>=2 && row<=sh.getLastRow()) sh.deleteRow(row);
      return json_({ok:true});
    }

    return json_({ok:false, error:'Unknown admin type'},400);
  }catch(err){ return json_({ok:false,error:String(err)}, 500); }
}

function doGet(e){
  try{
    const p = e.parameter || {};
    const type = (p.type||'').toLowerCase();

    // Public GET for chat preview on index (no token)
    if(type==='chat' && p.list && !p.token){
      const sh = ensureSheet_(SHEET_CHAT, ['timestamp','name','message','ua']);
      const last = sh.getLastRow();
      if(last<2) return json_({ok:true, rows:[]});
      const values = sh.getRange(2,1,last-1,4).getValues();
      const rows = values.map(r=>({timestamp:r[0], name:r[1], message:r[2]}));
      return json_({ok:true, rows});
    }

    // Admin GET (needs token)
    needToken_(p);

    if(type==='rsvp'){
      const sh = ensureSheet_(SHEET_RSVP, ['timestamp','name','attending','guests','email','message','c1name','c1age','c2name','c2age','c3name','c3age','c4name','c4age','ua']);
      const last = sh.getLastRow();
      if(last<2) return json_({ok:true, rows:[]});
      const vals = sh.getRange(1,1,last,15).getValues();
      const header = vals.shift();
      const rows = vals.map((r,i)=>{
        const o={}; header.forEach((h,idx)=>o[h]=r[idx]); o._row = i+2; return o;
      });
      return json_({ok:true, rows});
    }

    if(type==='chat' && p.list){
      const sh = ensureSheet_(SHEET_CHAT, ['timestamp','name','message','ua']);
      const last = sh.getLastRow();
      if(last<2) return json_({ok:true, rows:[]});
      const vals = sh.getRange(1,1,last,4).getValues();
      const header = vals.shift();
      const rows = vals.map((r,i)=>{
        const o={}; header.forEach((h,idx)=>o[h]=r[idx]); o._row = i+2; return o;
      });
      return json_({ok:true, rows});
    }

    if(type==='texts' && p.list){
      const sh = ensureSheet_(SHEET_TEXTS, ['key','value']);
      const last = sh.getLastRow();
      if(last<2) return json_({ok:true, items:{}});
      const vals = sh.getRange(2,1,last-1,2).getValues();
      const items = {}; vals.forEach(r=>{ items[r[0]] = r[1]; });
      return json_({ok:true, items});
    }

    if(type==='gallery' && p.list){
      const sh = ensureSheet_(SHEET_GAL, ['id','timestamp','filename','url']);
      const last = sh.getLastRow();
      if(last<2) return json_({ok:true, rows:[]});
      const vals = sh.getRange(2,1,last-1,4).getValues();
      const rows = vals.map(r=>({id:String(r[0]), timestamp:r[1], filename:r[2], url:r[3]}));
      return json_({ok:true, rows});
    }

    return json_({ok:false, error:'Unsupported GET'}, 400);
  }catch(err){ return json_({ok:false,error:String(err)}, 500); }
}

/* einmalig ausf√ºhren, um den Token zu setzen */
function setToken(){ PropertiesService.getScriptProperties().setProperty('TOKEN','030520'); }
